<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cat & Mouse - Multiplayer!</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #2c3e50; color: #ecf0f1; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .game-container { text-align: center; background: #34495e; padding: 20px; border-radius: 15px; box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        h1 { margin-top: 0; color: #f1c40f; }
        #loginScreen { padding: 40px; }
        #loginScreen input { padding: 10px; font-size: 1rem; margin-right: 10px; border-radius: 5px; border: none; }
        #gameArea { position: relative; width: 900px; height: 600px; background: #27ae60; border: 5px solid #1e8449; border-radius: 10px; margin: 20px auto; overflow: hidden; cursor: none; }
        .character { position: absolute; font-size: 2.5rem; transform: translate(-50%, -50%); }
        #cheese { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { transform: translate(-50%, -50%) scale(1); } 50% { transform: translate(-50%, -50%) scale(1.1); } 100% { transform: translate(-50%, -50%) scale(1); } }
        .ui-panel { display: flex; justify-content: space-between; align-items: center; font-size: 1.2rem; margin-bottom: 10px; }
        .score-display { display: flex; gap: 20px; }
        .score { font-weight: bold; color: #f1c40f; }
        #gameOverScreen { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.75); color: white; justify-content: center; align-items: center; flex-direction: column; border-radius: 10px; z-index: 100; }
        #gameOverScreen h2 { font-size: 3rem; margin: 0; color: #e74c3c; }
        #gameOverScreen p { font-size: 1.5rem; margin: 10px 0; }
        .instructions { margin-top: 15px; font-size: 0.9rem; color: #bdc3c7; }
    </style>
</head>
<body>
    <div class="game-container">
        <h1>Cat & Mouse - Multiplayer!</h1>
        
        <div id="loginScreen">
            <h2>Enter Your Name</h2>
            <input type="text" id="nameInput" placeholder="Your Name" maxlength="15">
            <button id="joinButton">Join Game</button>
        </div>

        <div id="gameScreen" style="display: none;">
            <div class="ui-panel">
                <div class="score-display">
                    <div>You: <span id="myScore" class="score">0</span></div>
                    <div id="otherPlayerInfo"></div>
                </div>
                <button id="startButton" style="display: none;">Start Game</button>
            </div>
            <div id="gameArea">
                <!-- Players and cheese will be added by JS -->
                <div id="gameOverScreen">
                    <h2>Game Over!</h2>
                    <p id="gameOverMessage"></p>
                    <button id="restartButton">Play Again</button>
                </div>
            </div>
        </div>
        <div class="instructions">
            First player is the Mouse (üê≠), second is the Cat (üê±). Mouse collects cheese, Cat catches the mouse!
        </div>
    </div>

    <!-- You MUST include this library to connect to the server -->
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const loginScreen = document.getElementById('loginScreen');
        const gameScreen = document.getElementById('gameScreen');
        const nameInput = document.getElementById('nameInput');
        const joinButton = document.getElementById('joinButton');
        const gameArea = document.getElementById('gameArea');
        const myScoreEl = document.getElementById('myScore');
        const otherPlayerInfoEl = document.getElementById('otherPlayerInfo');
        const gameOverScreen = document.getElementById('gameOverScreen');
        const gameOverMessageEl = document.getElementById('gameOverMessage');
        const restartButton = document.getElementById('restartButton');

        const socket = io("http://localhost:3000"); // Connect to our local server

        let myPlayer = null;
        let otherPlayer = null;
        let cheese = null;
        let gameRunning = false;

        // --- LOGIN ---
        joinButton.addEventListener('click', () => {
            const name = nameInput.value.trim();
            if (name) {
                socket.emit('newPlayer', name);
                loginScreen.style.display = 'none';
                gameScreen.style.display = 'block';
            }
        });

        // --- GAME LOGIC ---
        socket.on('gameState', (state) => {
            myPlayer = state.players[socket.id];
            cheese = state.cheese;
            updateGameArea();
        });

        socket.on('newPlayerJoined', (player) => {
            otherPlayer = player;
            updateOtherPlayerInfo();
            if(myPlayer.isMouse) gameRunning = true; // Game starts when cat joins
        });

        socket.on('playerMoved', (data) => {
            if (otherPlayer && otherPlayer.id === data.id) {
                otherPlayer.x = data.x;
                otherPlayer.y = data.y;
                updateOtherPlayerPosition();
            }
        });

        socket.on('cheeseUpdate', (data) => {
            cheese = data.newCheese;
            updateCheesePosition();
            // Optional: Show a message who scored
            console.log(`${data.scorer} collected the cheese!`);
        });

        socket.on('gameOver', (data) => {
            gameRunning = false;
            gameOverMessageEl.textContent = `${data.catcher} caught ${data.caught}!`;
            gameOverScreen.style.display = 'flex';
            myScoreEl.textContent = myPlayer.score;
        });

        socket.on('playerLeft', (playerId) => {
            if (otherPlayer && otherPlayer.id === playerId) {
                gameArea.querySelector(`#${playerId}`).remove();
                otherPlayer = null;
                updateOtherPlayerInfo();
                gameRunning = false;
            }
        });

        // --- MOVEMENT & COLLISIONS ---
        gameArea.addEventListener('mousemove', (e) => {
            if (!gameRunning || !myPlayer) return;
            const rect = gameArea.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            // Update local position instantly for smooth movement
            myPlayer.x = x;
            myPlayer.y = y;
            updateMyPosition();

            // Send position to server
            socket.emit('playerMove', { x, y });

            // Check for collisions
            checkCollisions();
        });

        function checkCollisions() {
            if (!myPlayer || !cheese) return;

            // Check cheese collision (only for mouse)
            if (myPlayer.isMouse && getDistance(myPlayer, cheese) < 40) {
                socket.emit('cheeseCollected');
            }

            // Check cat/mouse collision
            if (otherPlayer) {
                const isMouseAndCat = (myPlayer.isMouse && !otherPlayer.isMouse) || (!myPlayer.isMouse && otherPlayer.isMouse);
                if (isMouseAndCat && getDistance(myPlayer, otherPlayer) < 40) {
                    const catcherId = myPlayer.isMouse ? otherPlayer.id : myPlayer.id;
                    socket.emit('playerCaught', catcherId);
                }
            }
        }

        // --- DOM UPDATES ---
        function updateGameArea() {
            if (!myPlayer || !cheese) return;
            gameArea.innerHTML = ''; // Clear area

            // Add me
            const meEl = document.createElement('div');
            meEl.id = socket.id;
            meEl.className = 'character';
            meEl.textContent = myPlayer.isMouse ? 'üê≠' : 'üê±';
            meEl.style.left = `${myPlayer.x}px`;
            meEl.style.top = `${myPlayer.y}px`;
            gameArea.appendChild(meEl);

            // Add other player if they exist
            if (otherPlayer) {
                const otherEl = document.createElement('div');
                otherEl.id = otherPlayer.id;
                otherEl.className = 'character';
                otherEl.textContent = otherPlayer.isMouse ? 'üê≠' : 'üê±';
                otherEl.style.left = `${otherPlayer.x}px`;
                otherEl.style.top = `${otherPlayer.y}px`;
                gameArea.appendChild(otherEl);
            }

            // Add cheese
            const cheeseEl = document.createElement('div');
            cheeseEl.id = 'cheese';
            cheeseEl.className = 'character';
            cheeseEl.textContent = 'üßÄ';
            cheeseEl.style.left = `${cheese.x}px`;
            cheeseEl.style.top = `${cheese.y}px`;
            gameArea.appendChild(cheeseEl);
            
            // Re-add game over screen
            gameArea.appendChild(gameOverScreen);
        }

        function updateMyPosition() {
            const meEl = gameArea.querySelector(`#${socket.id}`);
            if (meEl) {
                meEl.style.left = `${myPlayer.x}px`;
                meEl.style.top = `${myPlayer.y}px`;
            }
        }

        function updateOtherPlayerPosition() {
            if (!otherPlayer) return;
            const otherEl = gameArea.querySelector(`#${otherPlayer.id}`);
            if (otherEl) {
                otherEl.style.left = `${otherPlayer.x}px`;
                otherEl.style.top = `${otherPlayer.y}px`;
            }
        }
        
        function updateCheesePosition() {
            const cheeseEl = gameArea.querySelector('#cheese');
            if (cheeseEl) {
                cheeseEl.style.left = `${cheese.x}px`;
                cheeseEl.style.top = `${cheese.y}px`;
            }
        }

        function updateOtherPlayerInfo() {
            if (otherPlayer) {
                otherPlayerInfoEl.innerHTML = `${otherPlayer.name}: <span class="score">${otherPlayer.score}</span>`;
            } else {
                otherPlayerInfoEl.innerHTML = 'Waiting for another player...';
            }
        }

        function getDistance(obj1, obj2) {
            const dx = obj1.x - obj2.x;
            const dy = obj1.y - obj2.y;
            return Math.sqrt(dx * dx + dy * dy);
        }

        restartButton.addEventListener('click', () => {
            gameOverScreen.style.display = 'none';
            // For simplicity, just reload the page to restart
            window.location.reload();
        });
    </script>
</body>
</html>
